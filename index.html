<!DOCTYPE html>
<html lang="en">
	<head>
		<title>Critter World</title>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
		<script src="js/lib/jquery-1.7.2.min.js"></script>
		<link rel="stylesheet" type="text/css" href="style.css">

		<script src="js/utils.js"></script>
		<script src="http://threejs.org/build/three.js"></script>
		<script src="http://threejs.org/examples/js/Detector.js"></script>
		<script src="http://threejs.org/examples/js/libs/stats.min.js"></script>

	</head>

	<body>
		<script>
      /*
       *  TODO standardize URL into variable
       * port -> 8989
       *  check if file is invalid -> unneeded
       */
      var SERVER_URL = "http://localhost:8989/CritterWorld/";
      $(document).ready(function() {
        $("#run_world").click(function() {
          $.post(SERVER_URL + "run?rate=2.0", function() {
            alert("success");
          });
        });

        $("#stop_world").click(function() {
          $.post(SERVER_URL + "run?rate=0", function() {
            alert("success");
          });
        });

        //attacker1.crit is server side - INVALID
        // $("#run_world").click(function() {
        // $.post(SERVER_URL + "world", data = {
        // "definition" : "rock 5 2\nrock 6 4\ncritter attacker1.crit 6 2 0\n"
        // }, function() {
        // alert("success");
        // });
        // });

        var since = 1;
        $("#get_world").click(function() {
          var response = $.ajax({
            url : SERVER_URL + "world?update_since=" + since,
            type : "GET",
            dataType : "json",
            crossDomain : true,

          }).done(function(data, status) {
            console.log(data);
            //alert("Data: " + data + "\nStatus: " + status);
          }).fail(function(error, status) {
            console.log("error");
            console.log(error);
            console.log(status);
            alert("error");
          });
        });

        $("#load_world").click(function() {
          $.post(SERVER_URL + "step?count=1", function() {
            alert("success");
          });
        });

        $("#post_critter").click(function() {
          $.post(SERVER_URL + "step?count=1", function() {
            alert("success");
          });
        });

        $("#get_critter").click(function() {
          var jqxhr = $.getJSON(SERVER_URL + "critters", function(data) {
            console.log(data);
          })
        });

        $("#get_critters").click(function() {
          var jqxhr = $.getJSON(SERVER_URL + "critters", function(data) {
            console.log(data);
          })
        });

      });
		</script>
		<div id="critter_menu">
			Upload File
			<input type="file" id="file_upload">

			<div id="drop_zone">
				Drop files here
			</div>
			<output id="list"></output>

			<div id="byte_range"></div>
			<div id="byte_content"></div>
			<span class="readBytesButtons"> <!--   <button data-startbyte="0" data-endbyte="4">1-5</button>
				<button data-startbyte="5" data-endbyte="14">6-15</button>
				<button data-startbyte="6" data-endbyte="7">7-8</button> -->
				<button>
					entire file
				</button> </span>
			<script>
        function readBlob(opt_startByte, opt_stopByte) {

          var files = document.getElementById('file_upload').files;
          if (!files.length) {
            alert('Please select a file!');
            return;
          }

          var file = files[0];
          var start = parseInt(opt_startByte) || 0;
          var stop = parseInt(opt_stopByte) || file.size - 1;

          var reader = new FileReader();

          // If we use onloadend, we need to check the readyState.
          reader.onloadend = function(evt) {
            console.log(evt);
            if (evt.target.readyState == FileReader.DONE) {// DONE == 2
              document.getElementById('byte_content').textContent = evt.target.result;
              var prog = (evt.target.result);
              //console.log(prog);

              var myString = prog;
              // var myRegexp = /[a-z]+: ([0-9]+)/g;//[\n]*(.)+");
              var lines = myString.split('\n');
              var mems = [];
              var program = "";
              for (var i in lines) {
                var line = lines[i];
                var match = /[a-z]+: ([0-9]+)/g.exec(line);
                if (match === null) {
                  // if null, then we are matching a program
                  program += line + '\n';
                } else {
                  mems.push(parseInt(match[1]));
                }
              };

              var fu1 = document.getElementById("file_upload");
              specie_name = (fu1.value.split(/(\\|\/)/g).pop().split(".")[0]);

              // console.log(match);
              // for ( i = 0; i < match.length; i++) {
              // console.log(i + ": " + match[i]);
              // }
              send_data = {
                "program" : program,
                "mem" : mems,
                "species_id" : specie_name,
                "positions" : [{
                  "row" : 0,
                  "col" : 0
                }, {
                  "row" : 0,
                  "col" : 1
                }]
              };
              console.log(send_data);

              $.ajax({
              url : SERVER_URL + "critters",
              type:"POST"
              data : JSON.stringify(send_data),
              processData : false,
              dataType : 'json'
              }).
              done(function() {
                alert("success");
              }).fail(function() {
                alert("failed")
              });
              document.getElementById('byte_range').textContent = ['Read bytes: ', start + 1, ' - ', stop + 1, ' of ', file.size, ' byte file'].join('');
            }
          };

          var blob = file.slice(start, stop + 1);
          reader.readAsBinaryString(blob);
        }


        document.querySelector('.readBytesButtons').addEventListener('click', function(evt) {
          if (evt.target.tagName.toLowerCase() == 'button') {
            var startByte = evt.target.getAttribute('data-startbyte');
            var endByte = evt.target.getAttribute('data-endbyte');
            readBlob(startByte, endByte);
          }
        }, false);

        // $(document).bind('dragover', function (e) {
        // var dropZone = $('#drop_zone'),
        // timeout = window.dropZoneTimeout;
        // if (!timeout) {
        // dropZone.addClass('in');
        // } else {
        // clearTimeout(timeout);
        // }
        // var found = false,
        // node = e.target;
        // do {
        // if (node === dropZone[0]) {
        // found = true;
        // break;
        // }
        // node = node.parentNode;
        // } while (node != null);
        // if (found) {
        // dropZone.addClass('hover');
        // } else {
        // dropZone.removeClass('hover');
        // }
        // window.dropZoneTimeout = setTimeout(function () {
        // window.dropZoneTimeout = null;
        // dropZone.removeClass('in hover');
        // }, 100);
        // });

        /////////////////////////////////////////////
        function handleFileSelect(evt) {
          evt.stopPropagation();
          evt.preventDefault();

          var files = evt.dataTransfer.files;
          // FileList object.

          // files is a FileList of File objects. List some properties.
          var output = [];
          for (var i = 0, f; f = files[i]; i++) {
            output.push('<li><strong>', escape(f.name), '</strong> (', f.type || 'n/a', ') - ', f.size, ' bytes, last modified: ', f.lastModifiedDate ? f.lastModifiedDate.toLocaleDateString() : 'n/a', '</li>');
          }
          document.getElementById('list').innerHTML = '<ul>' + output.join('') + '</ul>';
        }

        function handleDragOver(evt) {
          evt.stopPropagation();
          evt.preventDefault();
          evt.dataTransfer.dropEffect = 'copy';
          // Explicitly show this is a copy.
        }

        // Setup the dnd listeners.
        var dropZone = document.getElementById('drop_zone');
        dropZone.addEventListener('dragover', handleDragOver, false);
        dropZone.addEventListener('drop', handleFileSelect, false);
			</script>

			<!--
			{
			"program": "a critter program",
			"mem": [<memsize>, <defense>, <offense>,<size>,<energy>,<posture>],  // NOTE: first empty line marks end of mems
			"species_id" : "attacker1", //name of file -> uneditable after upload
			"positions": [
			{ "row": 2, "col": 3 },
			{ "row": 4, "col": 6 },
			...
			]

			OR
			"num" : <int>
			}

			Choose File

			-->

		</div>
		<div id="start_menu">
			<div id="init_canvas">

			</div>
			<div>
				<div id="right_menu">
					<div id="main_logo">
						CritterWorld
					</div>
					<div id="start_buttons">
						<!--	<div class="start_button" id="new_world">
						New World
						</div>

						<div class="start_button" id="load_world">
						Load World
						</div>
						<div class="start_button" id="multiplayer">
						Multiplayer
						</div>
						<div class="start_button">
						Options
						</div>-->
						<div class="start_button" id="run_world">
							Run World
						</div>
						<div class="start_button" id="stop_world">
							Stop World
						</div>
						<div class="start_button" id="post_world">
							Post World
						</div>
						<div class="start_button" id="get_world">
							Get World
						</div>
						<div class="start_button" id="step_world">
							Step World
						</div>
						<div class="start_button" id="load_critter">
							Load Critter
						</div>
						<div class="start_button" id="get_critters">
							Get Critters
						</div>
						<div class="start_button" id="get_critter">
							Get Critter
						</div>
						<div class="start_button" id="delete_critter">
							Delete Critter
						</div>

						<div style="visibility: hidden;">
							<span onclick="location.href='newUrl.php';">link</span>
						</div>

					</div>
				</div>
			</div>
		</div>
		<div id="page">
			<div id= "menubar">
				<div id="logo">
					Critter World
				</div>

				<div id="menu-items" style="float:left; display:inline;">
					<div class="menu-item" style="padding-right:18px;">
						World
					</div>
					<div class = "menu" id="menu-world">
						<img src="rsc/inset-rounded-border.svg" style="position: absolute;
						top: -5px;
						left: 70px;"/>
						<div>
							Load World
						</div>
						<div>
							Save World
						</div>
						<div class="divider"></div>
						<div>
							Add Critter
						</div>
					</div>
					<div class="menu-item">
						View
					</div>
					<div class = "menu" id="menu-view">
						<div>
							Show All Hexes
						</div>

					</div>
					<div class="menu-item" style="padding: 2px 8px 3px 8px;
					width: 60px;">
						Settings
					</div>
					<div class="menu-item">
						Help
					</div>

				</div>

			</div>

			<div id="main">
				<div id="world">

				</div>
				<div id="control-pane">
					<div id="header">
						World Stats:
					</div>
					<div id= "world-stats">
						<div class="stat">
							<span class="stat-label">Critter Count: </span><span class="stat-data" id="critter-count">0</span>
						</div>
						<br>
						<div class="stat">
							<span class="stat-label">Time:</span><span class="stat-data" id = "time-count">0</span>
						</div>
						<br>

						<div class="stat">
							<span class="stat-label">Current Hex: </span><span class="stat-data" id="current-hex">(0,0)</span>
						</div>
						<br>
						<div class="stat">
							<span class="stat-label">Type: </span><span class="stat-data" id="current-hex-type"> </span>
						</div>
					</div>

					<div id="controls"></div>
				</div>
			</div>
		</div>

		<!-- 		<script src="js/World.js"></script>
		<script src="js/Map.js"></script>
		<script src="js/Critter.js"></script>
		<script src="js/Animation.js"></script>
		<script src="js/lib/TerrainGeneration.js"></script>
		<script src="js/Terrain.js"></script>

		<script src="js/Water.js"></script>
		<script src="js/lib/MouseControls.js"></script>
		<script src="js/CritterControls.js"></script>
		<script src="js/Main.js"></script> -->

	</body>
</html>
